name: Pull Request Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-pr:
    name: Validate PR
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check PR title
      uses: amannn/action-semantic-pull-request@v5
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        types: |
          feat
          fix
          docs
          style
          refactor
          perf
          test
          chore
        requireScope: false
    
    - name: Check for merge conflicts
      run: |
        if git grep -q "<<<<<<< HEAD" .; then
          echo "âŒ Merge conflicts detected!"
          exit 1
        fi
        echo "âœ… No merge conflicts"
    
    - name: Validate branch name
      run: |
        BRANCH="${{ github.head_ref }}"
        if [[ ! $BRANCH =~ ^(feature|bugfix|hotfix|refactor|docs)/.+ ]]; then
          echo "âŒ Invalid branch name: $BRANCH"
          echo "Branch should follow pattern: feature/*, bugfix/*, hotfix/*, refactor/*, docs/*"
          exit 1
        fi
        echo "âœ… Branch name is valid"

  size-check:
    name: PR Size Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Check PR size
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;
          const additions = pr.additions || 0;
          const deletions = pr.deletions || 0;
          const changes = additions + deletions;
          
          console.log(`PR has ${additions} additions and ${deletions} deletions (total: ${changes} changes)`);
          
          let label = '';
          let message = '';
          
          if (changes < 50) {
            label = 'size/XS';
            message = 'âœ… This is a very small PR';
          } else if (changes < 200) {
            label = 'size/S';
            message = 'âœ… This is a small PR';
          } else if (changes < 500) {
            label = 'size/M';
            message = 'âš ï¸ This is a medium-sized PR';
          } else if (changes < 1000) {
            label = 'size/L';
            message = 'âš ï¸ This is a large PR. Consider breaking it down.';
          } else {
            label = 'size/XL';
            message = 'âŒ This is a very large PR! Please break it into smaller PRs.';
          }
          
          console.log(message);
          
          // Add label
          try {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: [label]
            });
          } catch (error) {
            console.log(`Could not add label: ${error.message}`);
          }

  changed-files:
    name: Check Changed Files
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v40
    
    - name: List changed files
      run: |
        echo "## ðŸ“ Changed Files" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          echo "- $file" >> $GITHUB_STEP_SUMMARY
        done
    
    - name: Check for sensitive files
      run: |
        SENSITIVE_FILES=".env .env.local application.properties application-prod.properties"
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          for sensitive in $SENSITIVE_FILES; do
            if [[ "$file" == *"$sensitive"* ]]; then
              echo "âš ï¸ Warning: Sensitive file modified: $file"
            fi
          done
        done

  lint-commit-messages:
    name: Lint Commit Messages
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install commitlint
      run: |
        npm install -g @commitlint/cli @commitlint/config-conventional
    
    - name: Validate commit messages
      run: |
        npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose || true
      continue-on-error: true

  auto-assign-reviewers:
    name: Auto Assign Reviewers
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    
    steps:
    - name: Auto assign reviewers
      uses: kentaro-m/auto-assign-action@v1.2.5
      with:
        configuration-path: '.github/auto-assign.yml'

  summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [validate-pr, size-check, changed-files]
    if: always()
    
    steps:
    - name: Generate PR summary
      run: |
        echo "## ðŸŽ‰ Pull Request Validation Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| PR Validation | ${{ needs.validate-pr.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Size Check | ${{ needs.size-check.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Changed Files | ${{ needs.changed-files.result }} |" >> $GITHUB_STEP_SUMMARY
